{{- if or .color .gradient .bg -}}
  {{- $image     := "" -}}
  {{- $opacity   := "" -}}
  {{- $parallax  := "" -}}
  {{- $grayscale := "" -}}

  {{- if .bg -}}
    {{- $image     = "bg-figure" -}}
    {{- $opacity   = cond (not (.opacity | and (ne .opacity 100))) "" (print "opacity-" .opacity) -}}
    {{- $parallax  = cond (not .parallax) "" (cond (or .box site.Data.design.performance.parallax) "parallax" "") -}}
    {{- $grayscale = cond (not .grayscale) "" "image--grayscale" -}}
  {{- end -}}

  {{ $divider_next := "" }}
  {{ if .divider | and (not .footer) }}
    {{ with .next }}
      {{ if not (or .color .gradient .bg) }}
        {{ if .divider }}
          {{ $flip_y      := cond (not .flip_y) "y" "" }}
          {{ $flip_x      := cond (not .flip_x) "x" "" }}
          {{ $flips       := "" }}
          {{ if or $flip_x $flip_y }}
            {{ $flips      = print "-" $flip_x $flip_y }}
          {{ end }}
          {{ $divider_next = print "divider--next divider--next-" $flips "-" .divider }}
          {{/*  {{ if partial `functions/divider-ratio` .divider }}
            {{ $divider = print $divider " divider--ratio" }}
          {{ end }}  */}}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{- if or .color .gradient -}}
    {{- if and .link .shadow site.Data.design.buttons.deep -}}
      <div class="bg-color bg-color--3d"></div>
    {{- end -}}
  {{- end -}}

  {{- $class := delimit (slice
    "bg-color"
    $image
    $parallax
    $divider_next
    | uniq) " "
  -}}

  <div class="{{ $class }}">
    {{- if partial `functions/is-iframe` .bg -}}
      <div class="bg-figure-video">
    {{- end -}}
      {{- partial "components/image" (dict
        "class"     (delimit (slice "bg-figure-image" $opacity $grayscale) " ")
        "src"       .bg
        "notlazy"   .header
        "bg"        true
        "container" $.container
        "span"      .box_span
      ) -}}
    {{- if partial `functions/is-iframe` .bg -}}
      </div>
    {{- end -}}
  </div>
{{- end -}}

{{- if .card -}}
  <div class="bg-card"></div>
{{- end -}}
