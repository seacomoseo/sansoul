{{- $show     := cond (not site.Data.styles.performance.show) "" " show" -}}
{{- $button   := cond (ne .collapsible.button "none") .collapsible.button "" -}}
{{- $fotn_alt := cond (not .collapsible.font_alt) "" "button--font-alt" -}}
{{- $headers  := .collapsible.headers -}}
<div class="collapsibles {{- if $headers }} collapsibles--headers{{ end }} box__block align-left {{- $show }}">
  {{- range $k, $v := .collapsibles -}}
    {{- with merge ($.collapsible | default dict) . -}}
      {{- $hn   := .hn | default (add $.level 1) -}}
      {{- $hs   := cond (eq .hs nil) "" (cond (eq .hs $hn) "" (print " h" .hs)) -}}
      {{- $open := and (not $k) .first_open }}
      <div class="collapsible {{- if $open }} collapsible--active{{ end }}">

        {{/*  TITLE  */}}
        <h{{ $hn }} class="collapsible__title {{- $hs }}">
          {{ if not $headers }}
            {{- $icon  := cond (not .icon) "circle-question" .icon -}}
            {{- $emoji := cond (not .icon) "‚ùî" .icon -}}
            <button type="button" class="collapsible__button button {{ $button }} {{ $fotn_alt }}">
            {{- partial "components/icon" (dict "class" "collapsible__icon" "icon" $icon "emoji" $emoji) -}}
            <i>{{ .title }}</i>
            {{- partial "components/icon" (dict "class" "collapsible__button-dot" "icon" "plus") -}}
            </button>
          {{ else }}
            <i>{{ .title }}</i>
            <button type="button" class="collapsible__button-dot button button--dot {{ $button }}">
              {{- $icon  := cond (not .icon) "angle-down" .icon -}}
              {{- partial "components/icon" (dict "class" "collapsible__icon" "icon" $icon) -}}
            </button>
          {{ end }}
        </h{{ $hn }}>

        {{/*  CONTENT  */}}
        <div class="collapsible__content content" {{- if not $open }} hidden="until-found"{{ end }}>
          {{- with .content -}}
            {{- partial "functions/md" (dict "content" . "not_header_links" true) -}}
          {{- end -}}
        </div>
      </div>
    {{- end -}}
  {{- end -}}
</div>


{{/*  SCHEMA  */}}

{{- $schema_questions := slice -}}
{{- range .collapsibles -}}
  {{- $schema_questions = $schema_questions | append (dict
    "@type" `Question`
    "name"  .title
    "acceptedAnswer" (dict
      "@type" `Answer`
      "text"  (.content | markdownify | plainify)
    )
  ) -}}
{{- end -}}
{{- $schema := dict
  "@context"   "https://schema.org"
  "@type"      "FAQPage"
  "@id"        (print page.Permalink "#schema-faq")
  "mainEntity" $schema_questions
  "isPartOf"   (dict "@id" page.Permalink)
-}}
{{- if hugo.IsProduction -}}
  {{- $schema = jsonify $schema -}}
{{- else -}}
  {{- $schema = debug.Dump $schema -}}
{{- end -}}
<script type="application/ld+json">
  {{- $schema | safeJS -}}
</script>