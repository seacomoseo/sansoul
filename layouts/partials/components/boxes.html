{{- $boxes         := .boxes | default slice -}}
{{- $box           := . -}}
{{- $level         := .level -}}
{{- $container     := .container -}}
{{- $showup        := site.Data.design.performance.showup -}}

{{- $columns       := .box.columns | default 1 -}}
{{- if eq .box.columns 0 -}}
  {{- $boxes_span  := 0 -}}
  {{- range $boxes -}}
    {{- $boxes_span = add $boxes_span (.span | default 1) -}}
  {{- end -}}
  {{- $columns      = cond (le $boxes_span 6) $boxes_span 3 -}}
{{- end -}}
{{- $columns_min   := .box.columns_min | default 1 -}}
{{- if eq .box.columns_min 0 -}}
  {{- $boxes_span  := 0 -}}
  {{- range $boxes -}}
    {{- $boxes_span = add $boxes_span (.span_min | default 1) -}}
  {{- end -}}
  {{- $columns_min  = cond (le $boxes_span 6) $boxes_span 3 -}}
{{- end -}}

{{- $is_wrap       := or (ne $columns 1) .box.columns_min .box.slider -}}

{{- with .box -}}
  {{- if $is_wrap -}}
    {{- $level        = add $.level 1 -}}

    {{/*  CLASS  */}}
    {{- $columns_sm   := cond (or (gt $columns 2) (eq $container "xs") (eq $container "sm")) "columns--sm" "" -}}
    {{/*  {{- $boxes_level  := print "columns--" (sub $level 1) -}}  */}}
    {{- $direction    := cond (not (.direction | or (eq .direction "right"))) "" (print "columns--" .direction) -}}
    {{- $group_radius := cond (not (.group_radius | and (not .slider))) "" "columns--radius" -}}
    {{- $align_y      := cond (not .align_y) "" (print "align-items-" .align_y) -}}
    {{- $align_x      := cond (not .align_x) "" (print "justify-" .align_x) -}}
    {{- $slider_items := cond (not .slider)  "box__type" "slider__items" -}}

    {{- $class := partial "functions/attr-delimit" (dict
      "attr"  "class"
      "array" (slice
        "columns"
        $columns_sm
        $direction
        $group_radius
        $align_y
        $align_x
        $slider_items
      )
    ) -}}


    {{/*  STYLE  */}}
    {{- $col_max := cond (eq $columns 1)     "" (print "--columns-max:" $columns) -}}
    {{- $col_min := cond (eq $columns_min 1) "" (print "--columns-min:" $columns_min) -}}
    {{- $gap     := cond (eq .gap nil)       "" (print "--columns-gap-max:" .gap) -}}
    {{- $gap_y   := cond (eq .gap_y nil)     "" (print "--columns-gap-ny:" .gap_y) -}}

    {{ $style := partial "functions/attr-delimit" (dict
      "attr"    "style"
      "delimit" ";"
      "array"   (slice
        $col_max
        $col_min
        $gap
        $gap_y
      )
    ) }}

    {{/*  SHOWUP  */}}
    {{ $showup := cond (and $showup (not .slider) (not .first)) "data-showup" "" }}

    {{/*  JOIN ATTRIBUTES  */}}
    {{ $attr := partial "functions/attr-delimit" (dict
      "array" (slice
        $class
        $style
        $showup
      )
    ) }}

    {{/*  SLIDER  */}}
    {{ if .slider }}
      <div class="slider box__type" {{ with .interval }}data-interval="{{ . }}"{{ end }}>
        <div class="slider__track">
    {{ end }}

    {{/*  BOXES  */}}
    <div {{ $attr | safeHTMLAttr }}>
  {{ end }}
{{ end }}

        {{ range $key, $value := $boxes }}
        
          {{/*  BOX  */}}
          {{- partial "components/box" (merge
            $.parent
            (dict
              "icon"     nil
              "image"    nil
              "link"     nil
              "color"    nil
              "gradient" nil
              "bg"       nil
              "padding"  nil
              "pill"     nil
              "align_x"  nil
            )
            $.box
            .
            (dict
              "id"          $.id
              "level"       $level
              "key"         $key
              "container"   $container
              "section"     $.section
              "first"       $.first
              "footer"      $.footer
              "columns"     $columns
              "columns_min" $columns_min
              "is_wrap"     $is_wrap
              "parent"      $.parent
              "form_lvl"    $.form_lvl
              "form_num"    (add $key 1)
            )
          ) -}}

        {{ end }}

{{- if $is_wrap -}}
  {{- with .box -}}
    </div>

    {{/*  SLIDER BUTTONS  */}}
    {{ if .slider }}
      </div>
        {{- partial "components/slider-buttons"
          (dict
            "items"   (len $boxes)
            "bullets" .bullets
            "arrows"  .arrows
            "button"  .button
          )
        -}}
      </div>
    {{ end }}
  {{ end }}
{{ end }}