{{- $config := site.Data.config -}}

{{- $title    := "" -}}
{{- with .Params.seo.title -}}
  {{- $title   = . | markdownify -}}
{{- else -}}
  {{- $title   = .Title | markdownify -}}
  {{- $pre    := cond .IsSection (print .Params.emoji " ") "" -}}
  {{- $atitle := print $pre $title " - " site.Title -}}
  {{- if lt (len $atitle) 65 -}}
    {{- $title = $atitle -}}
  {{- end -}}
{{- end -}}

{{- $desc := .Params.seo.desc
  | default .Params.sum
  | default .Summary
  | truncate 155
  | plainify
  | replaceRE `::.+?::` ""
-}}
{{- $img_og       := partial "func/img-og" . -}}
{{- $img          := $img_og.img -}}
{{- $aas          := partial "func/authors-article-sections" . -}}
{{- $authors      := $aas.authors -}}
{{- $art_sections := $aas.art_sections -}}
{{- $logo         := partial "func/logo" . -}}

{{- /*  BASIC  */}}
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ $title }}</title>

{{- with $desc }}
  <meta name="description" content="{{ . }}">
  <meta property="og:description" content="{{ . }}">
{{- end -}}

{{- /*  OPEN GRAPH  */}}
<meta property="og:site_name" content="{{ site.Title }}">
<meta property="og:logo" content="{{ $logo }}">
{{- if .IsHome }}
  <meta property="og:type" content="website">
{{- else }}
  <meta property="og:type" content="article">
  <meta property="og:title" content="{{ $title }}">
  {{- if eq .Params.base "article" }}
    {{ with .Date }}<meta property="article:published_time" content="{{ .Format `2006-01-02T15:04:05Z07:00` }}">{{ end }}
    {{ with .Lastmod }}<meta property="article:modified_time" content="{{ .Format `2006-01-02T15:04:05Z07:00` }}">{{ end }}
  {{- end -}}
{{- end -}}
{{ with .Lastmod }}<meta property="og:updated_time" content="{{ .Format `2006-01-02T15:04:05Z07:00` }}">{{ end -}}
{{- range $authors -}}
  {{- if reflect.IsMap . }}
    <meta name="author" content="{{ .name }}">
    <meta property="article:author" content="{{ .name }}">
  {{- end -}}
{{- end -}}
{{- range $art_sections -}}
  {{- if reflect.IsMap . }}
    <meta property="article:section" content="{{ .name }}">
  {{- end -}}
{{- end }}
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:locale" content="{{ .Params.locale | default .Lang }}">
{{- range .Translations }}
  <meta property="og:locale:alternate" content="{{ .Params.locale | default .Lang }}">
{{- end }}
<meta name="twitter:card" content="summary_large_image">
<meta name="image" content="{{ $img }}">
<meta property="og:image" content="{{ $img }}">

{{- /*  ANDROID THEME COLOR  */}}
<meta name="theme-color" content="{{ site.Data.styles.colors.main.color }}">

{{- /*  INDEXATION  */}}
<link rel="canonical" href="{{ .Permalink }}">
{{- if .IsTranslated -}}
  {{- range .AllTranslations }}
    <link rel="alternate" hreflang="{{ .Params.locale | default .Lang }}" href="{{ .Permalink }}">
  {{- end -}}
{{- end -}}
{{- if .Params.seo.noindex }}
  <meta name="robots" content="noindex">
{{- end -}}
{{- with site.Params.g_site_verify }}
  <meta name="google-site-verification" content="{{ . }}">
{{- end -}}

{{- /*  SCHEMA  */}}
<script type="application/ld+json">
{{ partial "schema/_" . | safeJS }}
</script>

{{/*  LOADER  */}}
{{ partial "head-loader" . }}

{{- /*  GOOGLE ANALYTICS  */ -}}
{{- if hugo.IsProduction -}}
  {{- with site.Params.ga4 -}}
    {{- $isPs := "false" -}}
    {{- if $config.ga4_pagespeed_hide -}}
      {{- $isPs = "${navigator.userAgent.includes('Chrome-Lighthouse')}" -}}
    {{- end -}}
    {{- $isCk := "true" -}}
    {{- if $config.cookies_legal -}}
      {{- $isCk = "${localStorage.controlcookieanalytics}" -}}
    {{- end }}
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
    <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
    <script>
      // GA4 base
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      // GA4 function
      function googleAnalytics() {
        if (!document.querySelector(`script[src*="gtag/js?id={{ . }}"]`)) {
          // Load GA4 script
          var ga = document.createElement('script');
          ga.async = true;
          ga.src = 'https://www.googletagmanager.com/gtag/js?id={{ . }}';
          document.head.appendChild(ga);
          // GA4 tags
          gtag('js', new Date());
          gtag('config', '{{ . }}');
        }
      }
      // If is not bot and if cookies law
      const isBot = /googlebot|bingbot|slurp|duckduckbot|baiduspider|yandexbot/i.test(navigator.userAgent)
      const isPs = `{{ $isPs }}` === 'true'
      const isCk = `{{ $isCk }}` === 'true'
      if (!isBot && !isPs && isCk) googleAnalytics()
    </script>
  {{- end -}}
{{- else }}
  <script>
    function gtag(...e) {
      const start = () => {
        console.log(...e)
      }
      if (localStorage.controlcookieanalytics) {
        start()
      } else {
        window.addEventListener('cookies:analytics', start, { once: true })
      }
    }
  </script>
{{- end -}}

{{- /*  SELF-HOSTED MATERIAL SYMBOLS  */ -}}
{{- $path := print "" -}}
{{- if hugo.IsProduction -}}
  {{- $time := partial "func/timestamp" . -}}
  {{- $path  = print site.BaseURL "fonts/icons." $time ".woff2" -}}
{{- else -}}
  {{- $style := site.Data.styles.icons.style -}}
  {{- $path   = print site.BaseURL "fonts/material-symbols-" $style ".woff2" -}}
{{- end }}
<link rel="preload" href="{{ $path }}" as="font" type="font/woff2" crossorigin>

{{- /*  SELF-HOSTED FONTS  */ -}}
{{- range hugo.Store.Get "fonts" }}
  {{ $family := urlize .family }}
  {{ $italic := cond (not .italic) "" "-italic" }}
  {{ $path    = print site.BaseURL "fonts/" $family "-" .weight $italic ".woff2" }}
  <link rel="preload" href="{{ $path }}" as="font" type="font/woff2" crossorigin>
{{- end -}}

{{- /*  CSS STYLES  */ -}}
{{- $css := partial "styles" . }}
<link rel="preload" href="{{ $css.RelPermalink }}" as="style" onload="this.onload=null;this.rel='stylesheet';document.documentElement.classList.remove('preload')">
<noscript><link rel="stylesheet" href="{{ $css.RelPermalink }}"></noscript>

{{- /*  FAVICON  */ -}}
{{- $favicon := resources.Get ($config.favicon | default "/u/base/icon.svg") -}}
{{- if not $favicon -}}
  {{- $favicon = resources.Get "/u/base/icon.png" -}}
{{- end -}}

{{- with $favicon -}}
  {{- $base     := urls.Parse site.BaseURL -}}
  {{- $base      = print $base.Path "favicon." -}}
  {{- $fav_ico  := print $base "ico" -}}
  {{- $fav_svg  := print $base "svg" -}}
  {{- $fav_png  := print $base "png" -}}
  {{- $favicons := slice -}}
  {{- with resources.Get "/u/base/favicon.ico" -}}
    {{- (. | resources.Copy $fav_ico).Publish -}}
  {{- else -}}
    {{- $favicons = slice (dict "from" .RelPermalink "ext" "ico") -}}
  {{- end }}
  <link rel="icon" sizes="any" href="{{ $fav_ico }}">

  {{- if hasSuffix . "svg" -}}
    {{- (. | resources.Copy $fav_svg).Publish }}
    <link rel="icon" type="image/svg+xml" href="{{ $fav_svg }}">
    {{- with resources.Get "/u/base/icon.png" -}}
      {{- (.Resize "192x192 png q1" | resources.Copy $fav_png).Publish -}}
    {{- else -}}
      {{- $favicons = $favicons | append (dict "from" .RelPermalink "ext" "png") -}}
    {{- end -}}
  {{- else -}}
    {{- (.Resize "192x192 png q1" | resources.Copy $fav_png).Publish -}}
  {{- end }}
  <link rel="icon apple-touch-icon" type="image/png" sizes="192x192" href="{{ $fav_png }}">

  {{- with $favicons -}}
    {{- (resources.FromString "favicons.json" (. | jsonify)).Publish -}}
  {{- end -}}
{{- end -}}

{{- /*  RSS  */ -}}
{{- with site.Home.OutputFormats.Get "RSS" }}
  <link rel="alternate feed" type="application/rss+xml" href="{{ .RelPermalink }}" title="{{ site.Title }}">
{{- end -}}
