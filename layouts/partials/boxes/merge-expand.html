{{ $box  := . }}
{{ $page := .Page | default page }}

{{/*  color and bgcp  */}}
{{/*  {{ $color := cond (ne .color nil) .color (cond (not .card) "" "black") }}  */}}
{{/*  {{ $color := cond (ne .color nil) .color (cond (not .card) "" "black") }}  */}}

{{ $color := .color }}
{{ if eq $color "hide" }}
  {{ $color = "" }}
{{ end }}
{{ if not $color }}
  {{ if .card }}
    {{ $color = "black" }}
  {{ end }}
{{ end }}

{{ $bgc   := partial "func/color-background" (dict "child" $color "parent" .bgcp) }}

{{/*  fit col  */}}
{{ $col_vl := mul .col_vl (.fit    | default 1.00) }}
{{ $col_vs := mul .col_vs (.fit_vs | default 1.00) }}

{{/*  bg and image  */}}
{{ $fade := cond (eq .fade "hide") "" .fade }}
{{ $bi   := cond (eq .bi   "hide") "" .bi   }}
{{ $img  := .img }}
{{ if .card }}
  {{ $img = "" }}
  {{ if not .bi }}
    {{ $bi = .img }}
  {{ end }}
{{ end }}
{{ $is_bg := or $bi $color $fade }}

{{/*  images  */}}
{{ $gallery := .gallery }}
{{ $imgs    := slice }}
{{ $rawimgs := slice }}
{{ range .imgs }}
  {{ $img    := dict "img" . "url"  . }}
  {{ $rawimgs = $rawimgs | append $img }}
{{ end }}
{{ range .limgs }}
  {{ $rawimgs = $rawimgs | append . }}
{{ end }}
{{ range $k, $v := $rawimgs }}
  {{ $alt := .alt }}
  {{ if not .alt }}
    {{ with $gallery }}
      {{ with .alt }}
        {{ $alt = print . " " (add $k 1) }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $img := merge . (dict "alt" $alt) }}
  {{ $imgs = $imgs | append $img }}
{{ end }}

{{/*  shade  */}}
{{ $ratio := .ratio }}
{{ with $ratio }}
  {{ if not (in . "/") }}
    {{ $ratio = print . "/1" }}
  {{ end }}
{{ else }}
  {{ if and .shade (not $img) }}
    {{ $ratio = "16/9" }}
  {{ end }}
{{ end }}

{{/*  url  */}}
{{ $url             := .url }}
{{ if $url }}
  {{ $out           := hasPrefix $url "http" }}
  {{ $is_anchor_url := hasPrefix $url "#" }}
  {{ $start_slash   := $url | findRE `^/` }}
  {{ if and (not $out) (not $is_anchor_url) (not $start_slash) }}
    {{ with resources.Get ($url | replaceRE `\#.*$` "") }}
      {{ $url        = .RelPermalink }}
    {{ end }}
  {{ end }}
{{ end }}

{{/*  boxes  */}}
{{ $boxes := slice }}
{{ range .boxes }}
  {{ $opts := dict "Page" $page "item" . }}
  {{ with partial "func/get-params-merge" $opts }}
    {{ $boxes = $boxes | append . }}
  {{ end }}
{{ end }}

{{/*  others  */}}
{{ $icon_pos       := .icon_pos | default (cond .main "sub" "top") }}
{{ $group_radius   := .group_radius | and (not .slider) }}
{{ $line           := and .line (not (and .icon (eq $icon_pos "sub"))) }}
{{ $show           := site.Data.config.show }}
{{ $is_title       := or .title .hanchor .menu_label }}
{{ $is_title_url   := and $url (eq .btn "hide") $is_title }}
{{ $is_btn_hide    := and $url (eq .btn "hide") (not $is_title) }}
{{ $is_btn_show    := and $url (ne .btn "hide") }}
{{ $is_btn_url     := or $is_btn_show $is_btn_hide }}

{{/*  wrap  */}}
{{ $box_wrap := or
  .boxes_wrap
  .fit
  .fit_vs
  .node
  $is_bg
  .side
  .scroll
  .pd
  .pill
  .align
  .align_vl
  .align_x
  .order
  .space
}}

{{/*  sort  */}}
{{ $sort := .sort
  | default slice
  | append
  "img"
  "title"
  "icon_sub"
  "sub"
  "price"
  "md"
  "steps"
  "gallery"
  "list"
  "faq"
  "reviews"
  "dots"
  "when"
  "links"
  "form"
  "map"
  "gss"
  "boxes"
  "tags"
  "btn"
  | uniq
}}

{{/*  merge  */}}
{{ $to_merge := dict
  "Page"         $page
  "bgcp"         $bgc.parent
  "color"        $bgc.child
  "col_vl"       $col_vl
  "col_vs"       $col_vs
  "is_bg"        $is_bg
  "fade"         $fade
  "bi"           $bi
  "img"          $img
  "imgs"         $imgs
  "ratio"        $ratio
  "url"          $url
  "boxes"        $boxes
  "icon_pos"     $icon_pos
  "group_radius" $group_radius
  "line"         $line
  "show"         $show
  "is_title_url" $is_title_url
  "is_btn_hide"  $is_btn_hide
  "is_btn_url"   $is_btn_url
  "box_wrap"     $box_wrap
  "sort"         $sort
  "prev"         nil
  "next"         nil
  "limgs"        nil
}}
{{ $box = merge . $to_merge }}

{{/*  hide string params  */}}
{{ $box = partial "func/hide" (dict "item" $box) }}

{{ return $box }}