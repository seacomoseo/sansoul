{{ define "partials/check" }}
  {{ $if := true }}
  {{ with .if }}
    {{ if eq . "content" }}
      {{ $if = $.Page.RawContent }}
    {{ else if eq . "related" }}
      {{ $if = or $.Page.Params.related (and $.Page.Params.is_related ($.Page.CurrentSection.Pages.Related $.Page)) | and (not $.Page.IsSection) }}
    {{ else if eq . "comments" }}
      {{ $if = and site.Params.disqus $.Page.Params.is_comments (not $.Page.IsSection) }}
    {{ else if eq . "children" }}
      {{ $if = or $.Page.IsSection $.Page.Params.tax_of }}
    {{ else if eq . "collection" }}
      {{ $if = $.Page.IsSection }}
    {{ else if eq . "taxonomy" }}
      {{ $is_parent   := $.Page.Params.tax_of }}
      {{ $is_not_root := not $.Page.IsSection }}
      {{ $if = and $is_parent $is_not_root }}
    {{ else if eq . "true" }}
      {{ $if = true }}
    {{ else if eq . "false" }}
      {{ $if = false }}
    {{ else if eq . "author" }}
      {{ $if = and (not $.Page.IsSection) $.Page.Params.author }}
    {{ else }}
      {{ $opts := dict "Page" page "name" . }}
      {{ $if    = partial "functions/param" $opts }}
      {{ if $if }}
        {{ if eq . "toc" }}
          {{ $if = false }}
          {{ with $.Page.RawContent }}
            {{ with . | findRE `\n#+ ` }}
              {{ $if = index . 1 }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ return $if }}
{{ end }}

{{ $if := true }}
{{ if ne .if nil }}
  {{ $not  := false }}
  {{ $cond := .if }}

  {{/*  NOT  */}}
  {{ if .if | findRE `^not ` }}
    {{ $not  = true }}
    {{ $cond = .if | replaceRE `^not ` "" }}
  {{ end }}

  {{ if $cond | findRE `^or ` }}
    {{/*  OR  */}}
    {{ $if   = false }}
    {{ $cond = $cond | replaceRE `^or ` "" }}
    {{ $all := slice }}
    {{ range split $cond " " }}
      {{ $if = or $if (partial "check" (dict "Page" $.Page "if" .)) }}
      {{ if eq page.Slug "blog" }}{{ partial "warn" $if }}{{ end }}
    {{ end }}
  {{ else if $cond | findRE `^and ` }}
    {{/*  AND  */}}
    {{ $if   = false }}
    {{ $cond = $cond | replaceRE `^and ` "" }}
    {{ $all := slice }}
    {{ range split $cond " " }}
      {{ $if = and $if (partial "check" (dict "Page" $.Page "if" .)) }}
    {{ end }}
  {{ else }}
    {{/*  SIMPLE  */}}
    {{ $if = partial "check" (dict "Page" .Page "if" $cond) }}
  {{ end }}

  {{/*  NOT  */}}
  {{ if $not }}
    {{ $if = not $if }}
  {{ end }}
{{ end }}
{{ return $if }}
