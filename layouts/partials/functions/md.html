{{ $store   := page.Store -}}
{{ $inline  := $store.Get "md_inline" }}
{{ $display := cond $inline "inline" "block" }}
{{ $md      := . | site.Home.RenderString (dict "display" $display) }}

{{ range $md | findRE `::.+?::` | uniq }}
  {{ $icon := . | replaceRE `^::|::$` "" }}
  {{ $html := partial "icon" (dict "icon" $icon) }}
  {{ $md    = replace $md . $html }}
{{ end }}

{{ range $md | findRE `(<blockquote class="(quotes|dittos).*?">)` | uniq }}
  {{ $left  := partial "icon" (dict "class" "quote-left"  "default" "quote") }}
  {{ $right := partial "icon" (dict "class" "quote-right" "default" "quote") }}
  {{ $html  := print . $left $right }}
  {{ $md     = replace $md . $html }}
{{ end }}

{{ $md = $md
  | replaceRE `(<div class="bg-color"></div>)<p>` `$1</div>`
  | replaceRE `<p( class="(.+?)")?>[\n\s]*(<a class="button|<button)` `<p class="buttons $2">$3`
  | replaceRE ` start="(.+?)"` ` style="--item: $1;"`
  | replaceRE `<li(.*?)>` `<li$1><div>`
  | replaceRE `<li(.*?)><div>(\n|<p>)*(<. class="link.+?>)?(<svg[^>]*?>.+?</svg>|<i [^>]*class="icon.*?">.*?</i>) ?` `<li class="li-icon"$1>$4<div>$2$3`
  | replaceRE `</li>` `</div></li>`
  | replaceRE `(?s)<p><figure(.+?)</figure></p>` `<figure$1</figure>`
  | replaceRE `"(footnote-ref|footnote-backref)"` `"$1 button button--sm"`
  | safeHTML
}}

{{ return $md }}