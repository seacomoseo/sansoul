{{ $icons := slice
  "brand:facebook-f"
  "brand:x-twitter"
  "brand:tiktok"
  "brand:instagram"
  "brand:youtube"
  "brand:linkedin-in"
  "brand:google"
}}

{{/*  Add default icons  */}}
{{ $def := slice
  "home"
  "play"
  "up"
  "down"
  "left"
  "right"
  "right_angle"
  "close"
  "cookies"
  "sitemap"
  "search"
  "question"
  "plus"
  "calendar"
  "calendar_edit"
  "calendar_start"
  "calendar_end"
  "clock"
  "geo"
  "copy"
  "send"
  "send_close"
  "send_checking"
  "send_submit"
  "send_error"
  "send_info"
  "review_star"
  "words"
  "address"
  "drop_down"
  "drop_up"
  "phone"
  "whatsapp"
  "upload"
  "mail"
  "translate"
  "langs"
  "user"
  "quote"
}}
{{ $d := site.Data.utilities.defaults }}
{{ $s := site.Data.styles.icons }}
{{ range $def }}
  {{ $icon := or (index $s .) (index $d .) }}
  {{ $icons = $icons | append $icon }}
{{ end }}

{{ $images := slice }}

{{/*  Get all contents like json strin  */}}
{{ $all  := slice }}
{{ $tpls := slice }}
{{/*  Pages not draft  */}}
{{ range site.AllPages }}
  {{ $all = $all | append .RawContent .Params }}
  {{ with .Params.tpl }}
    {{ $tpls = $tpls | append . }}
  {{ end }}
{{ end }}
{{/*  Types not hidden  */}}
{{ range site.Data.types }}
  {{ if not .hide }}
    {{ with .tpl }}
      {{ $tpls = $tpls | append . }}
    {{ end }}
  {{ end }}
{{ end }}
{{/*  Sections not hidden  */}}
{{ $sections := slice }}
{{ range $tpls | uniq }}
  {{ $all = $all | append . }}
  {{ with .sections }}
    {{ range . }}
      {{ with index site.Data.section .file }}
        {{ $sections = $sections | append . }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ range $sections | uniq }}
  {{ $all = $all | append . }}
{{ end }}
{{/*  Global values  */}}
{{ range site.Languages }}
  {{ $values := index site.Data (print "values." .Lang) }}
  {{ $all     = $all | append $values }}
  {{ $icon   := print "svg:flag-" .Lang }}
  {{ $icons   = $icons | append $icon }}
{{ end }}
{{ $all = $all | uniq | jsonify }}

{{/*  Change to hugo.IsProduction if inprove  */}}
{{ if true }}
  {{/*  Get glyphs and svg's  */}}

  {{/*  Get custom params  */}}
  {{ $icon_params    := slice "icon" "icon_right" "pin" "div" }}
  {{ $image_params   := slice "image" "hover" "video" "logo" "bi" }}
  {{ $gallery_params := slice "images" "limages" }}
  {{ $icon_vars      := slice "box_icon_id" "box_button_pin" "box_divider_id" }}
  {{ $image_vars     := slice "box_image_src" "box_image_hover" "box_image_no_video" "box_bg_image" "box_container_bg_image" }}
  {{ $gallery_vars   := slice "box_gallery_images" "box_gallery_limages" }}
  {{ range site.Data.customs }}
    {{ if in $icon_vars .var }}
      {{/*  Icons  */}}
      {{ with .name }}
        {{ $icon_params = $icon_params | append . }}
      {{ end }}
    {{ else if or (in $image_vars .var) (eq .widget "image" | and (not .multiple)) }}
      {{/*  Images  */}}
      {{ with .name }}
        {{ $image_params = $image_params | append . }}
      {{ end }}
    {{ else if or (in $gallery_vars .var) (eq .widget "image" | and .multiple) }}
      {{/*  Gallery  */}}
      {{ with .name }}
        {{ $gallery_params = $gallery_params | append . }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $icon_params    = delimit (uniq $icon_params )   "|" }}
  {{ $image_params   = delimit (uniq $image_params)   "|" }}
  {{ $gallery_params = delimit (uniq $gallery_params) "|" }}

  {{/*  Get icons  */}}
  {{ $icon_regex := print `"(` $icon_params `)":"(.*?)"|::(.*?)::` }}
  {{ range $all | findRESubmatch $icon_regex | uniq }}
    {{ $icon := or (index . 3) (index . 2) }}
    {{ if $icon }}
      {{/*  Add prefix div if is  */}}
      {{ $type := index . 1 }}
      {{ if eq $type "div" }}
        {{ $icon = print "div:" $icon }}
      {{ end }}
      {{/*  Append icon  */}}
      {{ $icons = $icons | append $icon }}
    {{ end }}
  {{ end }}

  {{/*  Get images  */}}
  {{ $image_regex := print `"(?:` $image_params `)":"(.*?)"|!\[.*?\]\((.*?)(?: ".*?")?\)|` }}
  {{ range $all | findRESubmatch $image_regex | uniq }}
    {{ $image := or (index . 3) (index . 2) (index . 1) }}
    {{ $images = $images | append $image }}
  {{ end }}
  {{ $gallery_regex := print `"(` $gallery_params `)":\[(.*?)\]` }}
  {{ range $all | findRESubmatch $gallery_regex | uniq }}
    {{ $gallery := index . 2 }}
    {{ range $gallery | findRESubmatch `"(.*?)"` | uniq }}
      {{ $image := index . 1 }}
      {{ $images = $images | append $image }}
    {{ end }}
  {{ end }}

{{ else }}
  {{/*  Not needed glyphs in dev mode  */}}

  {{/*  Get all svg files from media dir (omit brands because simple-icons is hard)  */}}
  {{ $svgs   := resources.Match "media/**/*.svg" }}
  {{ $brands := resources.Match "media/icons/brands/*.svg" }}
  {{ $divs   := resources.Match "media/dividers/*.svg" }}
  {{ $poster := slice "media/default-poster.svg" }}
  {{ $kept   := $svgs | complement $brands $divs $poster }}
  {{ range $kept }}
    {{ $image := .RelPermalink | replaceRE `^/media/` "" }}
    {{ $images = $images | append $image }}
  {{ end }}

  {{/*  Get brands  */}}
  {{ $brand_regex := `(brand:[\w-]+)` }}
  {{ range $all | findRE $brand_regex | uniq }}
    {{ $icons = $icons | append . }}
  {{ end }}

  {{/*  Get divs  */}}
  {{ range $divs }}
    {{ $icon := .RelPermalink | replaceRE `^/media/dividers/|\.svg$` "" }}
    {{ $icon  = print "div:" $icon }}
    {{ $icons = $icons | append $icon }}
  {{ end }}
  {{/*  alt  */}}
  {{/*
  {{ $icon_regex := print `"div":"(.*?)"` }}
  {{ range $all | findRESubmatch $icon_regex | uniq }}
    {{ $icon := index . 2 }}
    {{ if $icon }}
      {{ $icon = print "div:" $icon }}
      {{ $icons = $icons | append $icon }}
    {{ end }}
  {{ end }}
  */}}

{{ end }}

{{/*  Images to icons  */}}
{{ range $images }}
  {{ if . | findRE `\.svg$` }}
    {{ $image := . }}
    {{ with $image | findRESubmatch `[#&?]poster=([^#&]+)` }}
      {{ $image = index . 0 1 }}
    {{ end }}
    {{ $icon := $image | replaceRE `^/|^/?media/|^/?icons?/|\.svg$` "" | replaceRE `^(brand)s/` `$1-` }}
    {{ $icon  = print "svg:" $icon }}
    {{ $icons = $icons | append $icon }}
  {{ end }}
{{ end }}

{{/*  Add to Store  */}}
{{ range $icons | uniq }}
  {{ if ne . "hide" }}
    {{ $icon := . }}
    {{ $type := "glyphs" }}
    {{ range $icon | findRESubmatch `^(\w+):(.*)` }}
      {{ $icon = index . 2 }}
      {{ $type = index . 1 }}
      {{ $type = print $type "s" }}
      {{ if eq $type "brands" }}
        {{ $icon = print "brands/" $icon }}
        {{ $type = "svgs" }}
      {{ end }}
    {{ end }}
    {{ page.Store.Add $type $icon }}
  {{ end }}
{{ end }}

{{ return "" }}