{{- $img      := resources.Get .img -}}
{{- $img_base := $img -}}
{{- if $img -}}
  {{/*  Image x size to srcset  */}}
  {{- $s := site.Data.config.img_sizes | default 1.5 -}}


  {{- /*  PICTURE  */ -}}

  {{- $vid_data := .vid | not | not -}}
  {{- $vid_name := index .vid "name" | default "aux" -}}
  {{- $vid_src  := index .vid "src" -}}

  {{- $style := "" -}}
  {{- if $img | findRE `\.jpe?g$`  -}}
    {{- with $img.Colors -}}
      {{- $from := index . 0 -}}
      {{- $to   := index . 1 | default "transparent" -}}
      {{- $style = print "--pre-bg:linear-gradient(" $from "," $to ")" -}}
    {{- end -}}
  {{- end -}}

  {{- $pic_attrs := dict
    "class"    .class
    $vid_name  $vid_data
    "data-vid" $vid_src
    "style"    $style
  -}}
  {{- $pic_attrs = partial "func/attrs" $pic_attrs -}}


  {{- /*  IMG  */ -}}

  {{- $img_attrs := dict
    "src"      ($img_base.RelPermalink | safeURL)
    "alt"      .alt
    "width"    $img_base.Width
    "height"   $img_base.Height
    "decoding" "async"
    "loading"  .lazy
  -}}
  {{- $img_attrs = partial "func/attrs" $img_attrs -}}


  {{- /*  SOURCE  */ -}}

  {{- $source_attrs := "" -}}
  {{- if hugo.IsProduction -}}
    {{- $type := cond (not site.Data.config.webp) "avif" "webp" -}}

    {{- /* CONTAIN  */ -}}
    {{- if not .contain -}}
      {{- $ratio := .ratio -}}
      {{- if not $ratio -}}
        {{- if .disc -}}
          {{- $ratio = "1/1" -}}
        {{- end -}}
      {{- else if not (in $ratio "/") -}}
        {{- $ratio = print $ratio "/1" -}}
      {{- end -}}
      {{- with $ratio -}}
        {{- if ne . "auto" -}}
          {{- $ratio_split := split $ratio "/" -}}
          {{- $width_aim   := index $ratio_split 0 | float -}}
          {{- $height_aim  := index $ratio_split 1 | float -}}
          {{- $ratio_aim   := div $height_aim $width_aim -}}
          {{- $width_img   := $img.Width   | float -}}
          {{- $height_img  := $img.Height  | float -}}
          {{- $ratio_img   := div $height_img $width_img -}}
          {{- $w           := 300 -}}
          {{- $h           := 300 -}}
          {{- if ne $ratio_img $ratio_aim -}}
            {{- if gt $ratio_img $ratio_aim -}}
              {{- $w = $width_img -}}
              {{- $h = mul $width_img $ratio_aim | int -}}
            {{- else -}}
              {{- $w = div $height_img $ratio_aim | int -}}
              {{- $h = $height_img -}}
            {{- end -}}
            {{- $fill := print $w "x" $h " Center" -}}
            {{- $img   = $img.Fill $fill -}}
            {{- $path := $img | replaceRE `(.+)\.(.+)$` (print "$1-" $w "x" $h ".$2") -}}
            {{- $img   = $img | resources.Copy $path -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- $sizes       := slice -}}
    {{- $srcsizes    := slice -}}
    {{- $srcset      := slice -}}
    {{- $src_reverse := false -}}

    {{- /* SIZES  */ -}}
    {{- if .max -}}

      {{- if gt $img.Width .max -}}
        {{- $sizes = slice .max -}}
      {{- else -}}
        {{- $sizes = slice $img.Width -}}
      {{- end -}}

    {{- else if gt $img.Width 320 -}}

      {{- /*          problems
          background images (sections and columns items)
          fit with grow (columns items image)
      */ -}}

      {{- $fit_vl            := .fit_vl | default 1 -}}
      {{- $fit_vs            := .fit_vs | default 1 -}}
      {{- $containers        := site.Data.utilities.containers -}}
      {{- $container         := .container | default "fluid" -}}
      {{- $container_vl      := index $containers $container -}}
      {{- $container_vs      := 393 -}}
      {{- /* {{ $viewports := slice 375 425 768 1024 1280 }}  */ -}}
      {{- $viewports         := slice 425 768 1280 -}}
      {{- if lt $fit_vs 0.50 -}}
        {{- $viewports        = slice 375 768 1280 -}}
      {{- end -}}
      {{- if eq $container "fluid" -}}
        {{- $viewports        = $viewports | append 1440 -}}
      {{- end -}}
      {{- $vs                := site.Data.utilities.viewports.min -}}
      {{- $vl                := site.Data.utilities.viewports.max -}}
      {{- $size_vl           := mul $container_vl $fit_vl | float -}}
      {{- $size_vs           := mul $container_vs $fit_vs | float -}}

      {{- $sizes_base        := slice -}}
      {{- range $viewports -}}
        {{- $size            := 0 -}}
        {{- if eq $container "fluid" -}}
          {{- $size           = mul . $fit_vl -}}
        {{- else -}}
          {{- /* y = y1 + ( ((y2 - y1) * (x - x1)) / (x2 - x1) )  */ -}}
          {{- $size           = add $size_vs (div (mul (sub $size_vl $size_vs) (sub . $vs)) (sub $vl $vs)) -}}
        {{- end -}}
        {{- $sizes_base       = $sizes_base | append (dict "size" $size "viewport" .) -}}
      {{- end -}}

      {{- /* if first > last  */ -}}
      {{- if gt (index $sizes_base 0).size (index (last 1 $sizes_base) 0).size -}}
        {{- $src_reverse      = true -}}
        {{- $sizes_base       = $sizes_base | append (dict "size" 320 "viewport" 320) -}}
      {{- end -}}

      {{- $size_prev         := 10000 -}}
      {{- $img_next          := 0 -}}
      {{- $sizes_base_sort   := (sort $sizes_base "size" "desc") -}}
      {{- range $key, $value := $sizes_base_sort -}}

        {{- $size            := .size -}}
        {{- $img_size        := div $img.Width $s -}}

        {{- /* size = image_size only if size > image_size > next_size  */ -}}
        {{- /* hide because remove --vw fluid / set visual breackpoints
        {{- if le $img_size .size -}}
          {{- $size_next     := (index $sizes_base_sort (add $key 1)).size | default 0 -}}
          {{- if ge $img_size $size_next -}}
            {{- $img_next     = add $img_next 1 -}}
            {{- if eq $img_next 1 -}}
              {{- $size       = $img_size -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
        */ -}}
        {{/*  size = breakpoint **anterior** más cercano  */}}
        {{- $size_prev_obj := (index $sizes_base_sort (sub $key 1)) -}}
        {{- if $size_prev_obj -}}
          {{- $size_prev_val := $size_prev_obj.size -}}
          {{- /* si la imagen ya cubre el breakpoint anterior, úsalo */ -}}
          {{- if ge $img_size $size_prev_val -}}
            {{- $size = $size_prev_val -}}
          {{- end -}}
        {{- end -}}

        {{- /* set size only if diference between size and size_prev is bigest that 100px  */ -}}
        {{- $is_size_far_prev := lt (sub $size $size_prev) (div -100 $s) -}}

        {{- if ge $img_size $size | and $is_size_far_prev -}}
          {{- /* each size here is a object  */ -}}
          {{- $sizes     = $sizes | append (dict "size" (mul $size $s | int) "viewport" .viewport) -}}
          {{- $size_prev = $size -}}
        {{- end -}}

      {{- end -}}

    {{- else -}}

      {{- $sizes = slice $img.Width -}}

    {{- end -}}

    {{- /* SOURCE BY SIZES  */ -}}
    {{- if gt (len $sizes) 1 -}}

      {{- /* SRCSIZES AND SRCSET  */ -}}
      {{ $last          := sub (len $sizes) 1 }}
      {{- range $i, $v  := sort $sizes "size" "desc" -}}
        {{- $viewport   := "(all)" -}}
        {{ if ne $i $last }}
          {{- $viewport  = print "(min-width:" (sub .viewport 1) "px)" -}}
        {{ end }}
        {{- $size       := div .size $s -}}
        {{- $size        = div (math.Round (mul $size 100)) 100 -}}
        {{- $srcsizes    = $srcsizes | append (print $viewport " " $size "px") -}}
        {{- $img_link   := partial "func/img-format" (dict "img" $img "img_base" $img_base "size" .size) -}}
        {{- $srcset      = $srcset | append (print $img_link " " .size "w") -}}
      {{- end -}}

      {{- $srcsizes      = delimit $srcsizes "," -}}
      {{- if $src_reverse -}}
        {{- $srcsizes    = $srcsizes | replaceRE "min" "max" -}}
      {{- end -}}
      {{- $srcset        = delimit $srcset "," -}}

    {{- else -}}

      {{- /* SRC  */ -}}
      {{- $img_width    := $img.Width -}}
      {{- if $sizes -}}
        {{- $img_width   = index $sizes 0 -}}
        {{- /* if is not a int > is a object  */ -}}
        {{- if ne (printf "%T" $img_width) "int" -}}
          {{- $img_width = $img_width.size -}}
        {{- end -}}
      {{- end -}}
      {{- $img_link     := partial "func/img-format" (dict "img" $img "img_base" $img_base "size" $img_width) -}}
      {{- $srcset        = print $img_link " " $img_width "w" -}}
      {{- $srcsizes      = "100dvw" -}}

    {{- end  -}}

    {{- /*  SOURCE ATTRS  */ -}}
    {{- $source_attrs = dict
      "type"   (print "image/" $type)
      "sizes"  $srcsizes
      "srcset" $srcset
      "width"  $img.Width
      "height" $img.Height
    -}}
    {{- $source_attrs = partial "func/attrs" $source_attrs -}}


  {{- end  -}}


  {{- /*  HTML  */}}
  <picture {{- $pic_attrs }}>
    {{- with $source_attrs }}
      <source {{- . }}/>
    {{- end }}
    <img {{- $img_attrs }}>
  </picture>


  {{- /*  ICON PLAY  */ -}}
  {{- with index .vid "play" }}
    {{ . -}}
  {{- end -}}


  {{- /*  SCHEMA  */}}
  {{ if not .notschema -}}
    {{- with .vid -}}
      {{- partial "schema/vid" (dict
        "name"         $.alt
        "thumbnailUrl" $img_base.Permalink
        "uploadDate"   $.upload
        "duration"     $.duration
        "contentUrl"   .url
        "embedUrl"     .src
      ) -}}
    {{- else -}}
      {{- partial "schema/img" (dict
        "url"     $img_base.Permalink
        "width"   $img_base.Width
        "height"  $img_base.Height
        "caption" .alt
      ) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
