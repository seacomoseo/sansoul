{{/*  Sources  */}}
{{- $srcs  := slice -}}
{{- with resources.Get .vid -}}
  {{- $srcs = $srcs | append . -}}
  {{- if ne .MediaType.SubType "webm" -}}
    {{- $webm := $.vid | replaceRE `\.(mp4|mov|avi)$` ".webm" -}}
    {{- with resources.Get $webm -}}
      {{- $srcs = $srcs | append . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/*  Process poster  */}}
{{- $img := .img -}}
{{- if .img -}}
  {{- if not .img_ext -}}
    {{- with resources.Get .img -}}
      {{- if hugo.IsProduction -}}
        {{- $img = partial "func/img-format" (dict "img" . "size" .Width) -}}
      {{- else -}}
        {{- $img = .RelPermalink -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/*  Attributes  */}}
{{- $notlazy_mute := and .notlazy .mute -}}
{{- $preload      := "" -}}
{{- if and (not $notlazy_mute) (not .mute) -}}
  {{- if or .notlazy .is_modal $img -}}
    {{- $preload = "none" -}}
  {{- end -}}
{{- end -}}
{{- $attrs := dict
  "class"       .class
  "width"       "640"
  "height"      "360"
  "controls"    (not .mute)
  "muted"       $notlazy_mute
  "loop"        $notlazy_mute
  "autoplay"    $notlazy_mute
  "playsinline" $notlazy_mute
  "preload"     $preload
  "data-mute"   (cond $notlazy_mute "" .mute)
  "poster"      $img
-}}
{{- $attrs = partial "func/attrs" $attrs -}}

{{- /*  HTML  */}}
<video {{- $attrs }}>
  {{ range $srcs }}
    <source src="{{ .RelPermalink }}{{ $.t }}" type="{{ .MediaType.Type }}">
  {{- end }}
</video>

{{- /*  schema  */}}
{{- $upload := .upload | default (os.Stat (replace .vid "/u/" "/uploads/")).ModTime }}
{{ partial "schema/vid" (dict
  "name"         .alt
  "thumbnailUrl" $img
  "uploadDate"   $upload
  "duration"     .duration
  "contentUrl"   .vid
  "embedUrl"     nil
) -}}
