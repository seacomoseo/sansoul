{{- $file := .src | replaceRE `#.*$` "" -}}
{{- $src  := resources.Get $file -}}
{{- $min  := $src -}}
{{- if $src -}}
  {{/*  get head, width and height  */}}
  {{- $head   := "" -}}
  {{- $width  := "" -}}
  {{- $height := "" -}}
  {{- with partial "functions/svg-sizes" $src.Content -}}
    {{- $head   = .head   -}}
    {{- $width  = .width  -}}
    {{- $height = .height -}}
  {{- end -}}
  {{- if and $width $height | not -}}
    {{- $width  = 512 -}}
    {{- $height = 512 -}}
  {{- end -}}
  {{- if $head -}}
    {{- $min  = $src | minify -}}
    {{- $alt := .alt -}}
    {{- if not $alt -}}
      {{- $alt = $file | replaceRE `^/media/(.+)\..*$` `$1` | humanize -}}
    {{- end -}}
    {{- $content := $min.Content | replaceRE `\n` "" -}}
    {{/*  print  */}}
    {{- if or ($content | findRE `svg-src`) (in .src "#src") -}}
      {{/*  image tag  */}}
      {{- $minify := $min.Content -}}
      {{- $src  = $minify | resources.FromString ($file | replaceRE `\.min\.svg$` `.svg`) -}}
      {{- $alt := .alt -}}
      {{- if not $alt -}}
        {{- $alt = .src | replaceRE `^/media/(.+)\..*$` `$1` | humanize -}}
      {{- end -}}
      {{- $lazy := cond (not .notlazy) "lazy" "" -}}
      {{- $img_attrs := dict
        "class"    .class
        "src"      (($minify | resources.FromString $src.RelPermalink).RelPermalink | safeURL)
        "alt"      $alt
        "width"    $width
        "height"   $height
        "decoding" "async"
        "loading"  $lazy
      -}}
      {{- $img_attrs = partial "functions/attrs" $img_attrs }}
      <img {{- $img_attrs }}>
    {{- else if $content | findRE `svg-html` -}}
      {{/*  svg html  */}}
      {{- if not ($head | findRE ` width=`) -}}
        {{- $content = replace $content "<svg" (print "<svg width='" $width "'") -}}
      {{- end -}}
      {{- if not ($head | findRE ` height=`) -}}
        {{- $content = replace $content "<svg" (print "<svg height='" $height "'") -}}
      {{- end -}}
      {{- if .class -}}
        {{- $content = replace $content "<svg" (print "<svg class='" .class "'") -}}
      {{- end -}}
      {{- $content | safeHTML -}}
    {{- else -}}
      {{/*  svg sprite  */}}
      {{- $attrs := dict "class" .class "width" $width "height" $height "aria-label" $alt -}}
      {{- $attrs  = partial "functions/attrs" $attrs -}}
      {{- $draws := partial "functions/draws-base" . -}}
      {{- $id    := $file | replaceRE `^/media/(icons?/)?|.svg$` "" | replaceRE `^(brand)s/` `$1-` | replaceRE `/` "-" -}}
      {{- $href  := print $draws "#" $id }}
      <svg {{- $attrs }}><use href="{{ $href }}"></use></svg>
    {{- end -}}

    {{- /*  schema  */}}
    {{ if not .notschema -}}
      {{- partial "schema/image" (dict
        "url"     $min.Permalink
        "width"   $width
        "height"  $height
        "caption" $alt
      ) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
