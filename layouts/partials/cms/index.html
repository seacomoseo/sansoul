{{- $t        := partial "functions/i18n-cms" . -}}
{{- $lang_cms := partial "functions/lang-cms" . -}}
{{- $config   := index (where site.Data.langs "lang" $lang_cms) 0 -}}
{{- $netlify  := getenv "NETLIFY" -}}
{{- $default  := site.Data.utilities.defaults -}}
{{- $icons    := slice
  $default.single.icon
  $default.section.icon
  $default.types.icon
  $default.values.icon
  $default.settings.icon

  $default.config.icon
  $default.styles.icon
  $default.remote.icon
  $default.redirects.icon
  $default.robots.icon
-}}
{{- range site.Sections -}}
  {{- with .Params.icon -}}
    {{- $icons = $icons | append . -}}
  {{- end -}}
{{- end -}}
{{- range $icons -}}
  {{- partial "functions/draw-to-store" . -}}
{{- end -}}

<!doctype html>
<html lang="{{ $lang_cms }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ $t.cms }} Â· {{ $config.title }}</title>
  <meta name="robots" content="noindex">

  {{/*  CONFIG FILE  */}}
  {{ $path     := "../admin/config.yml" }}
  {{ $string   := partial "cms/config/_" . | string }}
  {{ $resource := resources.FromString $path $string | fingerprint }}
  <link href="{{ $resource.RelPermalink }}" type="application/yaml" rel="cms-config-url">

  {{/*  STYLES  */}}
  {{ $customs := slice }}
  {{ range site.Sections }}
    {{ $type := .Type }}
    {{ range .Params.customs | default slice }}
      {{ if not .default }}
        {{ if .pages }}
          {{ $custom := print $type ":" .name ":" (delimit .pages ",")  }}
          {{ $customs = $customs | append $custom }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $vars := dict
    "customs"   (delimit $customs "|")
    "divs"      (delimit site.Data.options.div "|")
    "timestamp" (partial "functions/timestamp" .)
  }}
  {{ $styles := resources.Get "css/cms.scss"
    | toCSS (dict "vars" $vars "enableSourceMap" hugo.IsDevelopment)
    | fingerprint
  }}
  {{ if hugo.IsProduction }}
    {{ $styles = $styles | minify }}
  {{ end }}
  <link rel="stylesheet" href="{{ $styles.RelPermalink }}">

</head>
<body style="--login: '{{ $t.login }}'">

  {{/*  SVELTIA CMS  */}}
  <script src="https://unpkg.com/@sveltia/cms/dist/sveltia-cms.js" type="module"></script>

  {{/*  CUSTOM SCRIPT  */}}
  {{ $opts := dict
    "minify"     hugo.IsProduction
    "targetPath" "../js/cms.js"
  }}
  {{ $js := resources.Get "js/cms/_index.js" | js.Build $opts | fingerprint }}
  {{ if hugo.IsProduction }}
    {{ $js = $js | minify }}
  {{ end }}
  <script src="{{ $js.RelPermalink }}"></script>

</body>
</html>
