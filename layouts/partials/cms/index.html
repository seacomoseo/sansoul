{{- $t        := partial "functions/i18n-cms" . -}}
{{- $lang_cms := partial "functions/lang-cms" . -}}
{{- $config   := index (where site.Data.config.langs "lang" $lang_cms) 0 -}}
{{- $netlify  := getenv "NETLIFY" -}}
{{- $default  := site.Data.utilities.defaults -}}
{{- $icons    := slice
  $default.single.icon
  $default.section.icon
  $default.types.icon
  $default.values.icon
  $default.settings.icon

  $default.config.icon
  $default.styles.icon
  $default.remote.icon
  $default.redirects.icon
  $default.robots.icon
-}}
{{- range site.Sections -}}
  {{- with .Params.icon -}}
    {{- $icons = $icons | append . -}}
    {{- partial "functions/draw-to-store" . -}}
  {{- end -}}
{{- end -}}

<!doctype html>
<html lang="{{ $lang_cms }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ $t.cms }} Â· {{ $config.title }}</title>
  <meta name="robots" content="noindex">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1024' height='1024' viewBox='0 0 512 512' fill='%23{{ replace site.Data.styles.colors.main.color `#` `` | default `767676` }}'%3E%3Cpath d='M200 0H312l17.2 78.4c15.8 6.5 30.6 15.1 44 25.4l76.5-24.4 56 97-59.4 54.1c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l59.4 54.1-56 97-76.5-24.4c-13.4 10.3-28.2 18.9-44 25.4L312 512H200l-17.2-78.4c-15.8-6.5-30.6-15.1-44-25.4L62.3 432.5l-56-97 59.4-54.1C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L6.3 176.5l56-97 76.5 24.4c13.4-10.3 28.2-18.9 44-25.4L200 0zm56 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z'/%3E%3C/svg%3E">

  {{/*  CONFIG FILE  */}}
  {{ $path   := print .RelPermalink "admin/config.yml" }}
  {{ if hugo.IsMultihost }}
    {{ $path  = print "../" .Lang "/admin/config.yml" }}
  {{ end }}
  {{ $string   := partial "cms/config/_" page | string }}
  {{ $resource := resources.FromString $path $string | fingerprint }}
  <link href="{{ $resource.RelPermalink }}" type="text/yaml" rel="cms-config-url">

  {{/*  STYLES  */}}
  {{ $params := slice }}
  {{ range site.Sections }}
    {{ $type := .Type }}
    {{ range .Params.customs | default slice }}
      {{ if not .default }}
        {{ if .pages }}
          {{ $append := print $type ":" .name ":" (delimit .pages ",")  }}
          {{ $params  = $params | append $append }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $i    := site.Data.styles.icons }}
  {{ $vars := dict
    "params"        (delimit $params "|")
    "timestamp"     (partial "functions/timestamp" .)
    "icons-fill"    ($i.fill    | not | not | int)
    "icons-weight"  ($i.weight  | default 400)
    "icons-grade"   ($i.grade   | default 0)
    "icons-optical" ($i.optical | default 24)
    "icons-style"   ($i.style   | default "outlined")
    "is-production" (hugo.IsProduction | not | not | string)
  }}
  {{/*
  "white"      (site.Data.styles.colors.base.white | default "#fff")
  "light"      (site.Data.styles.colors.base.light | default "#eee")
  "gray"       (site.Data.styles.colors.base.gray  | default "#282525")
  "dark"       (site.Data.styles.colors.base.dark  | default "#000")
  "black"      (site.Data.styles.colors.base.black | default "#767676")
  "cta"        (site.Data.styles.colors.cta.color  | default site.Data.styles.colors.main.color | default "#577399")
  "cta-light"  (site.Data.styles.colors.cta.light  | default "")
  "cta-dark"   (site.Data.styles.colors.cta.dark   | default "")
  "cta-contrast-text" (or (in (slice "all" "text") site.Data.styles.colors.cta.contrast) (not site.Data.styles.colors.cta.contrast) | not | not | string)
  "cta-contrast-fill" (or (in (slice "all" "fill") site.Data.styles.colors.cta.contrast) (not site.Data.styles.colors.cta.contrast) | not | not | string)
  */}}
  {{ $styles := resources.Get "css/cms.scss"
    | toCSS (dict "vars" $vars "enableSourceMap" hugo.IsDevelopment)
    | fingerprint
  }}
  {{ if hugo.IsProduction }}
    {{ $styles = $styles | minify }}
  {{ end }}
  <link rel="stylesheet" href="{{ $styles.RelPermalink }}">

  {{/*  NETLIFY IDENTITY  */}}
  {{ if $netlify }}
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  {{ end }}

</head>
<body style="--login: '{{ $t.login }}'">

  {{/*  SVELTIA CMS  */}}
  {{/*  <script src="https://unpkg.com/@sveltia/cms/dist/sveltia-cms.js" type="module"></script>  */}}

  {{/*  STATIC CMS  */}}
  <link rel="stylesheet" href="https://unpkg.com/@staticcms/app@^4.0.0/dist/main.css" />
  <script src="https://unpkg.com/@staticcms/app@^4.0.0/dist/static-cms-app.js"></script>

  {{/*  CUSTOM SCRIPT  */}}
  {{ $opts := dict
    "minify"     hugo.IsProduction
    "targetPath" (print site.Home.RelPermalink "js/cms.js")
    "params"     (dict
      "tReset"    $t.reset
      "icons"     $icons
      "netlify"   $netlify
      "lang"      $lang_cms
    )
  }}
  {{ $js := resources.Get "js/cms/_index.js" | js.Build $opts | fingerprint }}
  {{ if hugo.IsProduction }}
    {{ $js = $js | minify }}
  {{ end }}
  <script src="{{ $js.RelPermalink }}"></script>

</body>
</html>
