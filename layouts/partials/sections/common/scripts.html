{{ $config := partial "functions/config-lang" . }}

{{ $isCookies         := false -}}
{{ $isScrollShow      := false -}}
{{ $disqusId          := "" }}
{{ $isGoogleTranslate := false }}
{{ $googleAnalyticsId := "" }}
{{ $i18nVideo         := i18n `video` }}
{{ $lang              := page.Lang }}

{{ $formErrorSingleQuotes   := i18n "form-error-single-quotes" }}
{{ $formErrorRequiredFields := i18n "form-error-required-fields" }}
{{ $formErrorRequiredCheck  := i18n "form-error-required-check" }}
{{ $formErrorEmail          := i18n "form-error-email" }}
{{ $formErrorNumber         := i18n "form-error-number" }}
{{ $formErrorFile           := i18n "form-error-file" }}
{{ $formErrorAcept          := i18n "form-error-acept" }}
{{ $formSubmitOk            := i18n "form-submit-ok" }}
{{ $formSubmitWrong         := i18n "form-submit-wrong" }}
{{ $formsLoad    := partial "types/forms" (dict "js" true "Page" page)
  | replaceRE `\s{2,}` ` `
  | replaceRE `\n` ``
}}

{{ $custom       := (resources.Get "js/custom.js").Content -}}
{{ $customString := "" -}}

{{ if site.Data.design.performance.showup }}
  {{ $isScrollShow = true -}}
{{ end }}

{{ if site.GetPage "pages/cookies" }}
  {{ $isCookies = true }}
{{ end }}

{{ with $config.disqus }}
  {{ $disqusId = . }}
{{ end }}

{{ if .menu.google_translate }}
  {{ $isGoogleTranslate = true }}
{{ end }}

{{ if hugo.IsProduction }}
  {{ with $config.google_analytics }}
    {{ $googleAnalyticsId = . }}
  {{ end }}
{{ end }}

{{ with $config.custom_code.js.code }}
  {{ $customString =
    (.
      | resources.FromString (print "aux_js." page.Lang)
      | resources.ExecuteAsTemplate (print "aux_js." page.Lang) page
    ).Content
    | safeJS
  -}}
{{ end }}

{{ $asTemplate := print $formsLoad $custom $customString }}


{{ $opts := dict
  "targetPath" (print site.Home.RelPermalink "js/scripts.js")
  "params" (dict
    "isCookies"         $isCookies
    "isScrollShow"      $isScrollShow
    "disqusId"          $disqusId
    "isGoogleTranslate" $isGoogleTranslate
    "googleAnalyticsId" $googleAnalyticsId
    "i18nVideo"         $i18nVideo
    "lang"              $lang
    "formsLoad"               $formsLoad
    "formErrorSingleQuotes"   $formErrorSingleQuotes
    "formErrorRequiredFields" $formErrorRequiredFields
    "formErrorRequiredCheck"  $formErrorRequiredCheck
    "formErrorEmail"          $formErrorEmail
    "formErrorNumber"         $formErrorNumber
    "formErrorFile"           $formErrorFile
    "formErrorAcept"          $formErrorAcept
    "formSubmitOk"            $formSubmitOk
    "formSubmitWrong"         $formSubmitWrong
    "custom"       $custom
    "customString" $customString
  )
}}

{{ if hugo.IsProduction }}
  {{/*  "target" "es2015"  */}}
  {{ $opts = merge $opts (dict "minify" true) }}
{{ end }}

{{ $js := resources.Get "js/_index.js"
  | resources.ExecuteAsTemplate (print "aux_scripts." page.Lang) $asTemplate
  | js.Build $opts
}}

{{ if hugo.IsProduction }}
  {{ $js = $js | fingerprint }}
{{ end }}

<script src="{{ $js.RelPermalink }}" defer></script>
