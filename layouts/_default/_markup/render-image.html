{{- $alt       := .Text -}}
{{- $ratio     := "" -}}
{{- $col_vl    := 1.0 -}}
{{- $fig_class := "md__fig" -}}
{{- $fig_style := "" -}}
{{- $img_class := "img" -}}
{{- $img_style := "" -}}

{{- /* BORDER */ -}}
{{- /* Get the Page's Store */ -}}
{{- $store  := page.Store -}}
{{- $border := $store.Get "md_border" | default "" -}}
{{- with $border -}}
  {{- if ne . "hide" -}}
    {{- $border_class := print "img--border " (cond (ne "main" .) . "") -}}
    {{- $fig_class     = print $fig_class " " $border_class -}}
  {{- end -}}
{{- end -}}

{{- if in .Text "float" -}}

  {{- /* FLOAT */ -}}
  {{- $fig_class = print $fig_class " md__fig--float" -}}
  {{- if in .Text "float-right" -}}
    {{- $fig_class = print $fig_class " md__fig--float-right" -}}
  {{- end -}}
  {{- $alt    = $alt | replaceRE `float(-right)?` "" -}}
  {{- $col_vl = 0.5 -}}

  {{- $img_shape := resources.Get .Destination -}}
  {{- if not (in .Destination ".svg") -}}
    {{- $img_shape = $img_shape | images.Filter (images.Gamma -1) -}}
    {{- $img_shape = $img_shape.Resize (print 100 "x webp q10") -}}
    {{- $img_shape = $img_shape | resources.Copy ($img_shape | replaceRE `^(.+)\..+` `$1-shape.webp`) -}}
  {{- end -}}
  {{- $fig_style = ` style="--shape:url(` $img_shape.RelPermalink `)"` -}}

{{- else -}}

  {{- /*  RATIO or DISC IN TEXT, EXAMPLE: ![3/2](/u/example.jpg)  */ -}}
  {{- $is_ratio := .Text | findRE `^[\d/]+$` -}}
  {{- $is_disc  := eq .Text "disc" -}}
  {{- $is_vid   := partial "func/is-vid" .Destination -}}
  {{- if or $is_ratio $is_disc $is_vid -}}
    {{- if $is_disc -}}
      {{- $ratio     = "1/1" -}}
    {{- else -}}
      {{- $ratio     = or .Text "16/9" -}}
    {{- end -}}
    {{- $img_class = print $img_class " img--ratio" -}}
    {{- $img_style = print ` style="--img-ratio:` $ratio `"` -}}
    {{- $alt         = false -}}
  {{- else if $is_disc -}}
    {{- $img_class = print $img_class " img--disc" -}}
    {{- $alt         = false -}}
  {{- end -}}

{{- end -}}

<figure class="{{ $fig_class }}" {{- $fig_style | safeHTMLAttr }}>
  <div class="{{ $img_class }}" {{- $img_style | safeHTMLAttr }}>
    {{- partial "media/_" (dict
        "class"     "img__in"
        "img"       .Destination
        "ratio"     $ratio
        "alt"       $alt
        "container" "sm"
        "fit_vl"    $col_vl
        "fit_vs"    1
    ) -}}
  </div>
  {{- with .Title -}}
    <figcaption class="md__figcaption">
      {{- . -}}
    </figcaption>
  {{- end -}}
</figure>