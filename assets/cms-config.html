{{- $local            := eq (getenv "HUGO_CMS_LOCAL") "true" -}}
{{- $config           := partial "functions/config-lang" . -}}
{{- $fontawesome_link := print "[fontawesome.com](https://fontawesome.com/search?o=r&s=" (site.Data.styles.icons.type | default "solid") "&f=brands%2Cclassic)" -}}
{{- $langs := slice -}}
{{- range .Site.Languages -}}
  {{- $langs = $langs | append .Lang -}}
{{- end -}}


{{/*  VARIABLES  */}}
{{- $vars := (partial "cms/config/options" .)
  | append   (partial "cms/config/fields/base" .)
  | append   (partial "cms/config/fields/schema" .)
  | append   (partial "cms/config/fields/contact" .)
  | append   (partial "cms/config/fields/section-design" .)
  | append   (partial "cms/config/fields/data-menu" .)
  | append   (partial "cms/config/fields/data-articles-common" .)
  | append   (partial "cms/config/fields/section-rows" .)
  
  | append   (partial "cms/config/fields/sections-design" .)
  | append   (partial "cms/config/fields/main-pages-elements" $fontawesome_link)
  
  | append   (partial "cms/config/section-menu" (slice `~MENU_ITEMS_NORMAL` `~MENU_ITEMS_MORE`))
  | append   (partial "cms/config/section-sections" .)
-}}


{{/*  FINAL CMS CONFIG ==============================================================================
  EMAIL+PASS LOGIN WITH NETLIFY IDENTITY
    https://decapcms.org/docs/git-gateway-backend/
  "backend"       (dict
    "name"        `git-gateway`
    "branch"      `main`
    "site_domain" (site.BaseURL | replaceRE "^https?://" "")
  )
  BUTTON LOGIN WITH GITLAB (the other option without pkce adds Netlify as an intermediary unnecessarily)
    https://decapcms.org/docs/gitlab-backend/#client-side-pkce-authorization
  "backend" (dict
    "name"      "gitlab"
    "auth_type" "pkce"
    "repo"      (replace site.Params.git_url "https://github.com/" "")
    "app_id"    site.Params.git_app_id
  )
  BUTTON LOGIN WITH GITHUB
    https://decapcms.org/docs/github-backend/
  "backend" (dict
    "name"  "github"
    "repo"  (replace site.Params.git_url "https://github.com/" "")
  )
*/}}

{{- $cms_config :=
  (dict
    "_variables"    $vars
    "backend"       (dict
      "name"        `git-gateway`
      "branch"      `main`
      "site_domain" (site.BaseURL | replaceRE "^https?://" "")
    )
    "local_backend" $local
    "media_folder"  `assets/media`
    "public_folder" ``
    "media_library" (dict
      "max_file_size"  512000000
      "folder_support" true
    )
    "logo_url"      (print "/media/" ($config.logo | default "icon.png"))
    "locale"        .Lang
    "slug"          (dict
      "encoding"             `ascii`
      "clean_accents"        true
      "sanitize_replacement" `-`
    )
    "yaml"          (dict
      "parseOptions"    (dict
        "simpleKeys" true
      )
      "documentOptions" (dict
        "simpleKeys" true
      )
      "toStringOptions" (dict
        "simpleKeys"   true
        "singleQuote"  true
        "defaultStyle" `|`
        "blockQuote"   `literal`
        "width"        `Infinity`
        "indent"       2
        "indentSeq"    false
      )
    )
    "collections"   (partial "cms/config/collections" .)
  )
  | merge
  (cond
    $local
    (dict
      "site_url" site.BaseURL
    )
    (cond
      (not ($config.others.cms_editorial_workflow))
      (cond
        (not ($config.others.development))
        (dict
          "site_url"    site.BaseURL
          "display_url" (print site.Home.Permalink)
        )
        (dict
          "site_url"    (print "https://" site.Params.netlify_name ".netlify.app/")
        )
      )
      (dict
        "publish_mode" "editorial_workflow"
        "site_url"     (print "https://" site.Params.netlify_name ".netlify.app/")
      )
    )
  )
  (cond
    true
    (dict
      "i18n" (dict
        "structure"      `multiple_folders`
        "locales"        $langs
        "default_locale" .Lang
      )
    )
    dict
  )
-}}

{{- if hugo.IsProduction -}}
  {{- $cms_config = $cms_config | jsonify -}}
{{- else -}}
  {{- $cms_config = $cms_config | jsonify (dict "prefix" "" "indent" "  ") -}}
{{- end -}}
{{- $cms_config
  | replaceRE `"\\u003c\\u003c":` " <<: "
  | replaceRE `\"\\u0026(.+?)\":` ` "$1": &$1 `
  | replaceRE `\"~(.+?)\"` ` *$1 `
  | safeHTML
-}}




























{{- $remove := slice
  (dict
    "file"      `data/sections.yml`
    "extension" `yml`
    "label"     "sections"
    "name"      `sections`
    "fields"    (slice
      `~SECTIONS_DESIGN_GENERAL`
      `~SECTIONS_DESIGN_ALTERNATE`
    )
  )
  (dict
    "file"      `data/modals.yml`
    "extension" `yml`
    "label"     "modals"
    "name"      `modals`
    "fields"    `~MODALS_DESIGN_FIELDS`
  )
  (dict
    "file"      `data/menu.yml`
    "extension" `yml`
    "label"     "menu"
    "name"      `menu`
    "fields"    (slice
      (dict "label" `Logo`                              "name" `logo`                 "widget" `image`   "required" false "max_file_size" 512000000)
      `~COLOR`
      (dict "label" `Ancho de Despliegue`               "name" `screen_sticky`        "widget" `select`  "required" false "options" `~OPTIONS_SIZES_N_FLUID` "hint" "Es el ancho de la ventana a partir del cual el men칰 de las p치ginas seccionadas se mantiene desplegado en la parte superior 游댱 Si no se especifica, se mantendr치 siempre plegado")
      (dict "label" `Tama침o de Contenedor`              "name" `size_sticky`          "widget" `select`  "required" false "options" `~OPTIONS_SIZES`         "hint" "Es el ancho m치ximo del contenedor del men칰 desplegado de las p치ginas seccionadas")
      (dict "label" `Desplegado en Art칤culos`           "name" `articles_sticky`      "widget" `boolean` "default" false)
      (dict "label" `Inicio Transparente`               "name" `transparent`          "widget" `boolean` "default" false)
      (dict "label" `Ocultar Enlaces Ancla`             "name" `hide_anchors`         "widget" `boolean` "default" false                                     "hint" "Oculta todos los enlaces que se generan de forma autom치tica")
      (dict "label" `Ocultar Iconos`                    "name" `hide_icons`           "widget" `boolean` "default" false)
      (dict "label" `Mostrar Modales`                   "name" `show_modals`          "widget" `boolean` "default" false                                     "hint" "Mostrar enlaces hacia secciones de tipo modal como subelementos desplegables (no recomendado si hay muchos)")
      (dict "label" `Enlace Autom치tico al Blog`         "name" `show_blog_auto`       "widget" `boolean` "default" false                                     "hint" "Mostrar enlaces hacia entradas del blog autom치ticamente como subelementos desplegables en 'M치s'")
      (dict "label" `Enlace Autom치tico a Productos`     "name" `show_products_auto`   "widget" `boolean` "default" false                                     "hint" "Mostrar enlaces hacia productos autom치ticamente como subelementos desplegables en 'M치s'")
      (dict "label" `Enlace Autom치tico a Taxonom칤as`    "name" `show_taxonomies_auto` "widget" `boolean` "default" false                                     "hint" "Mostrar enlaces hacia taxonom칤as autom치ticamente como subelementos desplegables en 'M치s'")
      (dict "label" `Enlace Autom치tico al Buscador`     "name" `search`               "widget" `boolean` "default" false                                     "hint" "Ofrece un buscador r치pido para todos los contenidos que aparecer치 enlazado en el men칰")
      (dict "label" `Traductor de Google`               "name" `google_translate`     "widget" `boolean` "default" false                                     "hint" "A침ade en el men칰 la opci칩n de traducir autom치ticamente a m칰ltiples idiomas (no indexables por Google)")
      (dict "label" `Idiomas y Traductor en Men칰 "M치s"` "name" `langs_in_more`        "widget" `boolean` "default" false                                     "hint" "Cambia la ubicaci칩n de los enlaces de idiomas y traducci칩n al desplegable 'M치s'")
      (dict "label" `Idiomas Desplegados`               "name" `langs_out`            "widget" `boolean` "default" false                                     "hint" "Muestra los idiomas directamente sin nombres, fuera del desplegable 'M치s' aunque cambie la ubicaci칩n anterior")
      (dict "label" `Ocultar Botones de Esquina`        "name" `callnow_hide`         "widget" `boolean` "default" false                                     "hint" "Botones de la Esquina Inferior Izquierda que se suelen utilizar para llamadas a la acci칩n siempre visibles 游댱 Si est치 oculto y no se a침aden a continuaci칩n, se usar치 el primer n칰mero de WhatsApp o de tel칠fono que se encuentre en alguna secci칩n con botones contacto")
      `~MENU_ITEMS_CALLNOW`
      `~MENU_ITEMS_NORMAL`
      `~MENU_ITEMS_MORE`
    )
  )
-}}