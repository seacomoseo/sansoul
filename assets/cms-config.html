{{- $local            := eq (getenv "HUGO_CMS_LOCAL") "true" -}}
{{- $config           := partial "functions/config-lang" . -}}
{{- $fontawesome_link := print "[fontawesome.com](https://fontawesome.com/search?o=r&s=" (site.Data.styles.icons.type | default "solid") "&f=brands%2Cclassic)" -}}
{{- $langs := slice -}}
{{- range .Site.Languages -}}
  {{- $langs = $langs | append .Lang -}}
{{- end -}}


{{/*  VARIABLES  */}}
{{- $vars := (partial "cms/config/options" .)
  | append   (partial "cms/config/variables-base" $fontawesome_link)
  | append   (partial "cms/config/variables-contact" .)
  | append   (partial "cms/config/variables-section-design" .)
  | append   (partial "cms/config/variables-data-menu" .)
  | append   (partial "cms/config/variables-data-articles-common" .)
  | append   (partial "cms/config/variables-section-rows" .)
  
  | append   (partial "cms/config/sections-design-fields" .)
  | append   (partial "cms/config/variables-main-pages-elements" $fontawesome_link)
  
  | append   (partial "cms/config/section-menu" (slice `~MENU_ITEMS_NORMAL` `~MENU_ITEMS_MORE`))
  | append   (partial "cms/config/section-sections" .)
  | append   (partial "cms/config/collections-general" .)
  | append   (partial "cms/config/collections-rest" .)
-}}

{{/*  COLLECTIONS  */}}
{{- $collections := slice -}}
{{- if .GetPage "blog"       -}}{{ $collections = $collections | append `~COLLECTION_BLOG`       }}{{ end -}}
{{- if .GetPage "events"     -}}{{ $collections = $collections | append `~COLLECTION_EVENTS`     }}{{ end -}}
{{- if .GetPage "products"   -}}{{ $collections = $collections | append `~COLLECTION_PRODUCTS`   }}{{ end -}}
{{- if .GetPage "categories" -}}{{ $collections = $collections | append `~COLLECTION_CATEGORIES` }}{{ end -}}
{{- if .GetPage "tags"       -}}{{ $collections = $collections | append `~COLLECTION_TAGS`       }}{{ end -}}
{{- if .GetPage "authors"    -}}{{ $collections = $collections | append `~COLLECTION_AUTHORS`    }}{{ end -}}
{{- if .GetPage "custom"     -}}{{ $collections = $collections | append `~COLLECTION_CUSTOM`     }}{{ end -}}
{{- $collections = $collections | append
  `~COLLECTION_PAGES`
  `~COLLECTION_SECTIONED`
  `~COLLECTION_SECTIONS`
  `~COLLECTION_MODALS`
  `~COLLECTION_TYPES`
  `~COLLECTION_GENERAL`
-}}


{{/*  FINAL CMS CONFIG ==============================================================================
  EMAIL+PASS LOGIN WITH NETLIFY IDENTITY
    https://decapcms.org/docs/git-gateway-backend/
  "backend"       (dict
    "name"        `git-gateway`
    "branch"      `main`
    "site_domain" (site.BaseURL | replaceRE "^https?://" "")
  )
  BUTTON LOGIN WITH GITLAB (the other option without pkce adds Netlify as an intermediary unnecessarily)
    https://decapcms.org/docs/gitlab-backend/#client-side-pkce-authorization
  "backend" (dict
    "name"      "gitlab"
    "auth_type" "pkce"
    "repo"      (replace site.Params.git_url "https://github.com/" "")
    "app_id"    site.Params.git_app_id
  )
  BUTTON LOGIN WITH GITHUB
    https://decapcms.org/docs/github-backend/
  "backend" (dict
    "name"  "github"
    "repo"  (replace site.Params.git_url "https://github.com/" "")
  )
*/}}

{{- $cms_config := (dict
  "_variables"    $vars
  "backend"       (dict
    "name"        `git-gateway`
    "branch"      `main`
    "site_domain" (site.BaseURL | replaceRE "^https?://" "")
  )
  "local_backend"  $local
  "media_folder"  `assets/media`
  "public_folder" ``
  "media_library"    (dict
    "max_file_size"  512000000
    "folder_support" true
  )
)
| merge (cond
  $local
  (dict
    "site_url" site.BaseURL
  )
  (cond
    (not ($config.cms_editorial_workflow))
    (cond
      (not ($config.development))
      (dict
        "site_url"    site.BaseURL
        "display_url" (print site.Home.Permalink)
      )
      (dict
        "site_url"    (print "https://" site.Params.netlify_name ".netlify.app/")
      )
    )
    (dict
      "publish_mode" "editorial_workflow"
      "site_url"     (print "https://" site.Params.netlify_name ".netlify.app/")
    )
  )
)
| merge (cond
  true
  (dict
    "i18n" (dict
      "structure"      `multiple_folders`
      "locales"        $langs
      "default_locale" .Lang
    )
  )
  dict
)
| merge (dict
  "logo_url"               (print "/media/" ($config.logo | default "logo.svg"))
  "locale"                 .Lang
  "slug"                   (dict
    "encoding"             `ascii`
    "clean_accents"        true
    "sanitize_replacement" `-`
  )
  "yaml"              (dict
    "parseOptions"    (dict
      "simpleKeys"    true
    )
    "documentOptions" (dict
      "simpleKeys"    true
    )
    "toStringOptions" (dict
      "simpleKeys"    true
      "singleQuote"   true
      "defaultStyle"  `|`
      "blockQuote"    `literal`
      "width"         `Infinity`
      "indent"        2
      "indentSeq"     false
    )
  )
  "collections" $collections
) -}}

{{- if hugo.IsProduction -}}
  {{- $cms_config = $cms_config | jsonify -}}
{{- else -}}
  {{- $cms_config = $cms_config | jsonify (dict "prefix" " " "indent" "  ") -}}
{{- end -}}
{{- $cms_config
  | replaceRE `"\\u003c\\u003c":` " <<: "
  | replaceRE `\"\\u0026(.+?)\":` ` "$1": &$1 `
  | replaceRE `\"~(.+?)\"` ` *$1 `
  | safeHTML
-}}